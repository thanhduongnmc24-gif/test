name: Build Unsigned IPA for ESign

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-13
    # [QUAN TRỌNG] Thiết lập thư mục làm việc mặc định là folder 'ipa'
    defaults:
      run:
        working-directory: ./ipa 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          # Chỉ định đường dẫn file package-lock.json để cache hoạt động đúng
          cache-dependency-path: ipa/package-lock.json 

      - name: Install dependencies
        run: npm install

      - name: Expo Prebuild
        run: npx expo prebuild --platform ios --no-interactive --clean

      - name: Install Pods
        run: |
          cd ios
          pod install

      - name: Build Archive (No Signing)
        run: |
          cd ios
          xcodebuild archive \
            -workspace *.xcworkspace \
            -scheme "$(grep -m 1 'scheme = ' *.xcodeproj/xcshareddata/xcschemes/*.xcscheme | cut -d '"' -f 2)" \
            -configuration Release \
            -archivePath ../build/MyApp.xcarchive \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Create IPA from Archive
        run: |
          mkdir -p build/Payload
          mv build/MyApp.xcarchive/Products/Applications/*.app build/Payload/
          cd build
          zip -r -9 MyApp.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: app-unsigned
          # Upload file từ đúng đường dẫn bên trong folder ipa
          path: ipa/build/MyApp.ipa